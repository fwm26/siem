<script lang="ts">
  import { defineComponent } from 'vue';
  import Sidebar from '@/components/Sidebar.vue';
  import axios from 'axios';

  export default defineComponent({
    name: 'VulnerabilityScanner',
    components: {
    Sidebar  // Register Sidebar component
  },  
  data() {
    return {
      username: '', // Placeholder for the username
      errorCounts: {
        serverErrors: 10,
        clientErrors: 25,
        redirectErrors: 15,
        informational: 5
      },
      logs: [], // Array to hold logs
    };
  },
  mounted() {
    // Fetch the username and logs when the component is first mounted
    this.fetchUsername();
    this.fetchLogs();
  },
  activated() {
    // Fetch the username and logs when the component is re-activated from cache
    this.fetchUsername();
    this.fetchLogs();
  },
  methods: {
    async fetchUsername() {
      try {
        const response = await axios.get('http://localhost:8000/users/me', {
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}` // Send the token in the Authorization header
          }
        });
        this.username = response.data.username; // Set the username from the response
      } catch (err) {
        console.error('Error fetching username:', err);
        this.$router.push('/login'); // Redirect to login if unauthorized
      }
    },
    async fetchLogs() {
      try {
        const response = await axios.get('http://localhost:8000/logs', {
          headers: {
            Authorization: `Bearer ${localStorage.getItem('token')}` // Send the token in the Authorization header
          }
        });
        this.logs = response.data; // Store logs in the logs array
      } catch (err) {
        console.error('Error fetching logs:', err);
      }
    },
    logout() {
      localStorage.removeItem('token');
      this.$router.push('/login');
    },
    capitalizeFirstLetter(username: string) {
      if (!username) return '';
      return username.charAt(0).toUpperCase() + username.slice(1);
    }
  }
});
</script>

<template>
  <div class="dashboard-container">
    <Sidebar />
    <!-- Main Content -->
    <div class="main-content">
      <div>
        <div class="http-events-section">
          <h2>Logs</h2>
          <table class="logs-table">
            <thead>
              <tr>
                <th>Site URL</th>           
                <th>Timestamp</th>
                <th>Event</th>
                <th>User</th>
                <th>IP</th>
                <th>URL</th>
                <th>Method</th>
                <th>User Agent</th>
                <th>Extra</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="log in logs" :key="log.id">
                <td>{{ log.site_url }}</td>            
                <td>{{ log.timestamp }}</td>
                <td>{{ log.event }}</td>
                <td>{{ log.user }}</td>
                <td>{{ log.ip }}</td>
                <td>{{ log.url }}</td>
                <td>{{ log.method }}</td>
                <td>{{ log.user_agent }}</td>
                <td>{{ log.extra }}</td>
              </tr>
            </tbody>
          </table>
        </div>  
      </div>
    </div>
  </div>
</template>

<style>

  body, html {
    margin: 0;
    padding: 0;
    height: 100%; /* Ensure the body and html take full height */
    overflow-x: hidden; /* Prevent horizontal scrolling */
  }

  .dashboard-container {
    display: flex;
    height: 100vh; /* Ensure it takes the full viewport height */
    width: 100vw;  /* Ensure it doesn't overflow horizontally */
  }

  .main-content {
    margin-left: 20%; /* Make space for the fixed sidebar */
    padding: 20px;
    width: 80%;
  }


/* Welcome Message */
.welcome-message h1 {
  font-family: 'Poppins', sans-serif;
  margin-left: 30px;
  margin-bottom: 20px;
}

/* Events Section */
.http-events-section {
  width: 95%;
  max-width: 1280px;
  background-color: #fff;
  padding: 30px;  /* Generous padding */
}

.events-cards-container {
  display: flex;
  justify-content: space-between;
  gap: 20px;  /* Space between cards */
}

.event-card {
  flex: 1;
  background-color: white;
  padding: 15px;  /* Generous padding */
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.event-card h3 {
  margin-bottom: 10px;
  font-size: 1.25rem;
  color: #0B132B;
}

.event-card p {
  font-size: 2.5rem;
  font-weight: bold;
  color: #DB162F;
}

/* Styles for the logs table */

div.http-events-section:nth-child(5) > h3:nth-child(1){
  font-size: 1.25rem;
}

.logs-table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Poppins', sans-serif;  
}

.logs-table th, .logs-table td {
  padding: 12px;
  text-align: left;
}

.logs-table th {
  background-color: #EDC9FF;
}

.logs-table tr:nth-child(even) {
  background-color: #fafafa;
}

</style>
